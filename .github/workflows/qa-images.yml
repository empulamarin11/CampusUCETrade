name: Build & Push QA Images (GHCR)

on:
  push:
    branches: ["qa"]
    paths:
      - "services/**"
      - ".github/workflows/qa-images.yml"

jobs:
  build-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.QA_GHCR_USER }}
          password: ${{ secrets.QA_GHCR_TOKEN }}

      - name: Build & push microservices (qa)
        run: |
          set -e

          OWNER="${{ secrets.QA_GHCR_USER }}"
          TAG="qa"

          services=(
            auth-service
            user-service
            item-service
            reservation-service
            notification-service
            chat-service
            search-service
            delivery-service
            reputation-service
            traceability-service
          )

          for svc in "${services[@]}"; do
            echo "== Building $svc =="
            docker build \
              -t "ghcr.io/${OWNER}/campusucetrade-${svc%\-service}:${TAG}" \
              "services/${svc}"

            echo "== Pushing $svc =="
            docker push "ghcr.io/${OWNER}/campusucetrade-${svc%\-service}:${TAG}"
          done
