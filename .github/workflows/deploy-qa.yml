name: Deploy QA (EC2 via Bastion)

on:
  push:
    branches: ["qa"]
    paths:
      - "deploy/qa/**"
      - ".github/workflows/deploy-qa.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SSH key + known_hosts
        env:
          BASTION_HOST: ${{ secrets.QA_BASTION_HOST }}
        run: |
          set -e
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.QA_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Trust bastion
          ssh-keyscan -H "${BASTION_HOST}" >> ~/.ssh/known_hosts

      - name: Deploy to QA hosts through Bastion
        env:
          BASTION_HOST: ${{ secrets.QA_BASTION_HOST }}

          GHCR_USER: ${{ secrets.QA_GHCR_USER }}
          GHCR_TOKEN: ${{ secrets.QA_GHCR_TOKEN }}

          QA_DB_HOST: ${{ secrets.QA_DB_HOST }}
          QA_DB_NAME: ${{ secrets.QA_DB_NAME }}
          QA_DB_USER: ${{ secrets.QA_DB_USER }}
          QA_DB_PASSWORD: ${{ secrets.QA_DB_PASSWORD }}

          QA_JWT_SECRET: ${{ secrets.QA_JWT_SECRET }}

          # IMPORTANT: update these IPs when terraform recreates
          CORE_IP: "10.0.4.233"
          BUSINESS_IP: "10.0.4.206"
          OPS_IP: "10.0.4.125"
          REALTIME_IP: "10.0.4.181"
          MIDDLEWARE_IP: "10.0.4.222"
        run: |
          set -e

          ssh_exec () {
            HOST_IP="$1"
            shift
            ssh -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              -o ProxyJump=ubuntu@${BASTION_HOST} \
              ubuntu@${HOST_IP} "$@"
          }

          rsync_copy () {
            SRC_DIR="$1"
            HOST_IP="$2"
            DEST_DIR="$3"
            rsync -avz \
              -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ProxyJump=ubuntu@${BASTION_HOST}" \
              "${SRC_DIR}/" "ubuntu@${HOST_IP}:${DEST_DIR}/"
          }

          docker_login () {
            HOST_IP="$1"
            ssh_exec "$HOST_IP" "set -e
              echo '${GHCR_TOKEN}' | docker login ghcr.io -u '${GHCR_USER}' --password-stdin
            "
          }

          make_env_core () {
            HOST_IP="$1"
            ssh_exec "$HOST_IP" "cat > /home/ubuntu/deploy/core/.env <<'EOF'
            DATABASE_URL=postgresql+psycopg://${QA_DB_USER}:${QA_DB_PASSWORD}@${QA_DB_HOST}:5432/${QA_DB_NAME}
            REDIS_URL=redis://${MIDDLEWARE_IP}:6379/0
            JWT_SECRET=${QA_JWT_SECRET}
            JWT_ALGORITHM=HS256
            EOF"
          }

          make_env_business () {
            HOST_IP="$1"
            ssh_exec "$HOST_IP" "cat > /home/ubuntu/deploy/business/.env <<'EOF'
            DATABASE_URL=postgresql+psycopg://${QA_DB_USER}:${QA_DB_PASSWORD}@${QA_DB_HOST}:5432/${QA_DB_NAME}
            JWT_SECRET=${QA_JWT_SECRET}
            JWT_ALGORITHM=HS256
            S3_BUCKET=${QA_DB_NAME}-media
            S3_REGION=us-east-1
            EOF"
          }

          make_env_ops () {
            HOST_IP="$1"
            ssh_exec "$HOST_IP" "cat > /home/ubuntu/deploy/ops/.env <<'EOF'
            DATABASE_URL=postgresql+psycopg://${QA_DB_USER}:${QA_DB_PASSWORD}@${QA_DB_HOST}:5432/${QA_DB_NAME}
            JWT_SECRET=${QA_JWT_SECRET}
            JWT_ALGORITHM=HS256
            RABBITMQ_URL=amqp://guest:guest@${MIDDLEWARE_IP}:5672/
            KAFKA_BOOTSTRAP_SERVERS=${MIDDLEWARE_IP}:9092
            MQTT_HOST=${MIDDLEWARE_IP}
            MQTT_PORT=1883
            EOF"
          }

          make_env_realtime () {
            HOST_IP="$1"
            ssh_exec "$HOST_IP" "cat > /home/ubuntu/deploy/realtime/.env <<'EOF'
            DATABASE_URL=postgresql+psycopg://${QA_DB_USER}:${QA_DB_PASSWORD}@${QA_DB_HOST}:5432/${QA_DB_NAME}
            JWT_SECRET=${QA_JWT_SECRET}
            JWT_ALGORITHM=HS256
            EOF"
          }

          make_env_middleware () {
            HOST_IP="$1"
            ssh_exec "$HOST_IP" "cat > /home/ubuntu/deploy/middleware/.env <<'EOF'
            # Middleware usually has no DB
            EOF"
          }

          deploy_block () {
            NAME="$1"
            HOST_IP="$2"
            SRC_DIR="$3"
            ENV_FN="$4"

            echo "== Deploying ${NAME} to ${HOST_IP} =="

            ssh_exec "${HOST_IP}" "mkdir -p /home/ubuntu/deploy/${NAME}"
            rsync_copy "${SRC_DIR}" "${HOST_IP}" "/home/ubuntu/deploy/${NAME}"

            ${ENV_FN} "${HOST_IP}"

            docker_login "${HOST_IP}"

            ssh_exec "${HOST_IP}" "set -e
              cd /home/ubuntu/deploy/${NAME}
              docker compose --env-file .env pull || true
              docker compose --env-file .env up -d
              docker ps --format 'table {{.Names}}\t{{.Status}}' | head -n 30
            "
          }

          # 1) Middleware first
          deploy_block "middleware" "${MIDDLEWARE_IP}" "deploy/qa/middleware" "make_env_middleware"

          # 2) Then app blocks
          deploy_block "core" "${CORE_IP}" "deploy/qa/core" "make_env_core"
          deploy_block "business" "${BUSINESS_IP}" "deploy/qa/business" "make_env_business"
          deploy_block "ops" "${OPS_IP}" "deploy/qa/ops" "make_env_ops"
          deploy_block "realtime" "${REALTIME_IP}" "deploy/qa/realtime" "make_env_realtime"
