name: Deploy QA (EC2 via Bastion)

on:
  push:
    branches: ["qa"]
    paths:
      - "deploy/qa/**"
      - ".github/workflows/deploy-qa.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Academy)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Discover QA instance IPs by tags
        run: |
          set -e

          get_private_ip () {
            ROLE="$1"
            aws ec2 describe-instances \
              --filters "Name=tag:Role,Values=${ROLE}" "Name=instance-state-name,Values=running" \
              --query "Reservations[0].Instances[0].PrivateIpAddress" \
              --output text
          }

          get_public_ip () {
            ROLE="$1"
            aws ec2 describe-instances \
              --filters "Name=tag:Role,Values=${ROLE}" "Name=instance-state-name,Values=running" \
              --query "Reservations[0].Instances[0].PublicIpAddress" \
              --output text
          }

          echo "BASTION_HOST=$(get_public_ip bastion)" >> $GITHUB_ENV
          echo "CORE_IP=$(get_private_ip qa-core)" >> $GITHUB_ENV
          echo "BUSINESS_IP=$(get_private_ip qa-business)" >> $GITHUB_ENV
          echo "OPS_IP=$(get_private_ip qa-ops)" >> $GITHUB_ENV
          echo "REALTIME_IP=$(get_private_ip qa-realtime)" >> $GITHUB_ENV
          echo "MIDDLEWARE_IP=$(get_private_ip qa-middleware)" >> $GITHUB_ENV

          echo "Discovered BASTION_HOST=$BASTION_HOST"
          echo "Discovered CORE_IP=$CORE_IP"
          echo "Discovered BUSINESS_IP=$BUSINESS_IP"
          echo "Discovered OPS_IP=$OPS_IP"
          echo "Discovered REALTIME_IP=$REALTIME_IP"
          echo "Discovered MIDDLEWARE_IP=$MIDDLEWARE_IP"

      - name: Install SSH key
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/id_rsa << 'EOF'
          ${{ secrets.QA_SSH_PRIVATE_KEY }}
          EOF
          sed -i 's/\r$//' ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -y -f ~/.ssh/id_rsa >/dev/null

          ssh-keyscan -H ${{ env.BASTION_HOST }} >> ~/.ssh/known_hosts || true

      - name: Deploy to QA hosts through Bastion
        env:
          BASTION_HOST: ${{ secrets.QA_BASTION_HOST }}
          GHCR_USER: ${{ secrets.QA_GHCR_USER }}
          GHCR_TOKEN: ${{ secrets.QA_GHCR_TOKEN }}

          DB_HOSTPORT: "campusuce-trade-qa-postgres.cfy8cv49icv0.us-east-1.rds.amazonaws.com:5432"
          DB_NAME: "campusuce"
          DB_USER: "campusuce"
          DB_PASSWORD: ${{ secrets.QA_DB_PASSWORD }}

          JWT_SECRET: ${{ secrets.QA_JWT_SECRET }}
          JWT_ALGORITHM: "HS256"

          CORE_IP: "10.0.4.233"
          BUSINESS_IP: "10.0.4.206"
          OPS_IP: "10.0.4.125"
          REALTIME_IP: "10.0.4.181"
          MIDDLEWARE_IP: "10.0.4.222"
        run: |
          set -e

          deploy_block () {
            NAME="$1"
            HOST_IP="$2"
            SRC_DIR="$3"
            REDIS_URL="$4"

            echo "== Deploying $NAME to $HOST_IP =="

            rsync -avz -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ProxyJump=ubuntu@${BASTION_HOST}" \
              "${SRC_DIR}/" "ubuntu@${HOST_IP}:/home/ubuntu/deploy/${NAME}/"

            ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ProxyJump=ubuntu@${BASTION_HOST} ubuntu@${HOST_IP} "
              set -e
              cd /home/ubuntu/deploy/${NAME}

              cat > .env <<EOF
            DATABASE_URL=postgresql+psycopg://${DB_USER}:${DB_PASSWORD}@${DB_HOSTPORT}/${DB_NAME}
            REDIS_URL=${REDIS_URL}
            JWT_SECRET=${JWT_SECRET}
            JWT_ALGORITHM=${JWT_ALGORITHM}
            EOF

                        echo '${GHCR_TOKEN}' | docker login ghcr.io -u '${GHCR_USER}' --password-stdin
                        docker compose --env-file .env pull
                        docker compose --env-file .env up -d
                        docker ps --format 'table {{.Names}}\t{{.Status}}' | head -n 20
                        "
                    }

                    # Middleware first (no depende de Redis remoto)
                    deploy_block "middleware" "${MIDDLEWARE_IP}" "deploy/qa/middleware" "redis://127.0.0.1:6379/0"

                    # Redis vive en middleware host
                    REDIS_ON_MW="redis://${MIDDLEWARE_IP}:6379/0"

                    deploy_block "core" "${CORE_IP}" "deploy/qa/core" "${REDIS_ON_MW}"
                    deploy_block "business" "${BUSINESS_IP}" "deploy/qa/business" "${REDIS_ON_MW}"
                    deploy_block "ops" "${OPS_IP}" "deploy/qa/ops" "${REDIS_ON_MW}"
                    deploy_block "realtime" "${REALTIME_IP}" "deploy/qa/realtime" "${REDIS_ON_MW}"