events {}

http {
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log warn;

  upstream auth_service { server auth-service:8000; }
  upstream user_service { server user-service:8000; }
  upstream item_service   { server item-service:8000; }
  upstream search_service { server search-service:8000; }
  upstream reservation_service { server reservation-service:8000; }
  upstream delivery_service    { server delivery-service:8000; }
  upstream notification_service { server notification-service:8000; }
  upstream reputation_service   { server reputation-service:8000; }
  upstream traceability_service { server traceability-service:8000; }
  upstream chat_service { server chat-service:8000; }

  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }
  server {
    listen 80;

    # ALB healthcheck (exact match)
    location = / {
      default_type text/html;
      return 200 '<!doctype html><html><head><meta charset="utf-8"><title>CampusUCETrade</title></head><body style="font-family: Arial, sans-serif;"><h1>CampusUCETrade - QA</h1><p>ALB -> ASG -> EC2 is working âœ…</p></body></html>';
    }

    location /auth/ {
      rewrite ^/auth/?(.*)$ /$1 break;
      proxy_pass http://auth_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /auth;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Authorization $http_authorization;
    }

    location /users/ {
      rewrite ^/users/?(.*)$ /$1 break;
      proxy_pass http://user_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /users;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Authorization $http_authorization;
    }

    location /items/ {
      rewrite ^/items/?(.*)$ /$1 break;
      proxy_pass http://item_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /items;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /search/ {
      rewrite ^/search/?(.*)$ /$1 break;
      proxy_pass http://search_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /search;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /reservations/ {
      rewrite ^/reservations/?(.*)$ /$1 break;
      proxy_pass http://reservation_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /reservations;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /delivery/ {
      rewrite ^/delivery/?(.*)$ /$1 break;
      proxy_pass http://delivery_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /delivery;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /notifications/ {
      rewrite ^/notifications/?(.*)$ /$1 break;
      proxy_pass http://notification_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /notifications;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /reputation/ {
      rewrite ^/reputation/?(.*)$ /$1 break;
      proxy_pass http://reputation_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /reputation;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /traceability/ {
      rewrite ^/traceability/?(.*)$ /$1 break;
      proxy_pass http://traceability_service;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /traceability;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /chat/ {
      rewrite ^/chat/?(.*)$ /$1 break;
      proxy_pass http://chat_service;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Prefix /chat;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_read_timeout 3600;
    }

    location / {
      return 404;
    }
  }
}
